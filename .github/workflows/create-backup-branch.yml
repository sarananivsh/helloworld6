name: Create Mule3_backup Branch Before Other Workflows Start

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
    branches:
      - main          # Adjust to the base branch for your PR
  workflow_dispatch:  # This allows manual or API-triggered execution
jobs:
  create-backup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # Ensure GITHUB_TOKEN is being used

      - name: Check if Mule3_backup branch exists
        id: check_backup
        run: |
          BACKUP_BRANCH="Mule3_backup"
          if git ls-remote --heads origin "refs/heads/$BACKUP_BRANCH"; then
            echo "Backup branch '$BACKUP_BRANCH' already exists. Skipping creation."
            echo "backup_exists=true" >> $GITHUB_ENV
          else
            echo "Backup branch '$BACKUP_BRANCH' does not exist. It will be created."
            echo "backup_exists=false" >> $GITHUB_ENV
          fi

      - name: Create Mule3_backup branch (if not exists)
        if: env.backup_exists == 'false'
        run: |
          BACKUP_BRANCH="Mule3_backup"
          git fetch origin
          git checkout main  # Or use PR branch if needed
          git checkout -b $BACKUP_BRANCH
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} $BACKUP_BRANCH
          echo "Backup branch '$BACKUP_BRANCH' created and pushed successfully."
